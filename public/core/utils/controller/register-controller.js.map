{"version":3,"file":"register-controller.js","sources":["core/utils/controller/register-controller.ts"],"sourceRoot":"/","sourcesContent":["import { FastifyInstance } from 'fastify';\r\nimport UserModel from '../../features/user/models/user-model';\r\nimport createDecodeUserTokenUsecase from '../../features/user/usecases/decode-user-token';\r\nimport { decodeUserTokenErrors } from '../../features/user/usecases/decode-user-token/types';\r\nimport HttpError from '../errors/http-error';\r\nimport createLoggerService from '../services/logger-service';\r\nimport { Either } from '../types';\r\nimport { SYMBOL_DELETE, SYMBOL_GET, SYMBOL_PATCH, SYMBOL_POST, SYMBOL_PRIVATE, SYMBOL_PUT } from '../decorators/controller/symbols';\r\nimport { controllerAction, IControllerActionMeta } from '../decorators/controller/types';\r\n\r\nexport default function registerController(\r\n  path: string,\r\n  controller: object,\r\n  app: FastifyInstance\r\n) {\r\n  function processMeta(\r\n    symbol: symbol,\r\n    method: 'get' | 'post' | 'patch' | 'put' | 'delete'\r\n  ) {\r\n    if (Reflect.hasMetadata(symbol, controller.constructor)) {\r\n      const actions = Reflect.getMetadata(\r\n        symbol,\r\n        controller.constructor\r\n      ) as IControllerActionMeta[];\r\n      const privateRoutes = Reflect.getMetadata(\r\n        SYMBOL_PRIVATE,\r\n        controller.constructor\r\n      ) as string[];\r\n\r\n      actions.forEach(({ path: p, action }) => {\r\n        const actionPath = p === '/' ? '' : p\r\n        app[method](`${path}${actionPath}`, async (req, rep) => {\r\n          try {\r\n            let user: UserModel;\r\n            if (privateRoutes?.includes(action)) {\r\n              const decoder = createDecodeUserTokenUsecase();\r\n              const { auth } = req.headers;\r\n              const decodeResult: Either<decodeUserTokenErrors, UserModel> = await decoder.execute(String(auth));\r\n\r\n              if (decodeResult.isError) {\r\n                const error = new HttpError({\r\n                  message: 'Sorry, you need to specify a valid \"auth\" header token.',\r\n                  meta: decodeResult.error,\r\n                  statusCode: 403\r\n                });\r\n                return await rep.code(error.statusCode).send(error);\r\n              }\r\n\r\n              user = decodeResult.success;\r\n            }\r\n\r\n            const res = await (controller as Record<string, controllerAction>)[action](req, rep, user!);\r\n            return res;\r\n          } catch (e) {\r\n            const error = new HttpError({\r\n              message: (e as any).message,\r\n              meta: e\r\n            });\r\n\r\n            const logger = createLoggerService();\r\n            logger.error(error.message, error);\r\n            await rep.code(error.statusCode).send(error);\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  processMeta(SYMBOL_GET, 'get');\r\n  processMeta(SYMBOL_POST, 'post');\r\n  processMeta(SYMBOL_PATCH, 'patch');\r\n  processMeta(SYMBOL_PUT, 'put');\r\n  processMeta(SYMBOL_DELETE, 'delete');\r\n}\r\n"],"names":[],"mappings":";;;;;;;AAEA,uGAA0F;AAE1F,sEAA6C;AAC7C,gFAA6D;AAE7D,8DAAoI;AAGpI,SAAwB,kBAAkB,CACxC,IAAY,EACZ,UAAkB,EAClB,GAAoB;IAEpB,SAAS,WAAW,CAClB,MAAc,EACd,MAAmD;QAEnD,IAAI,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,UAAU,CAAC,WAAW,CAAC,EAAE,CAAC;YACxD,MAAM,OAAO,GAAG,OAAO,CAAC,WAAW,CACjC,MAAM,EACN,UAAU,CAAC,WAAW,CACI,CAAC;YAC7B,MAAM,aAAa,GAAG,OAAO,CAAC,WAAW,CACvC,wBAAc,EACd,UAAU,CAAC,WAAW,CACX,CAAC;YAEd,OAAO,CAAC,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE;gBACtC,MAAM,UAAU,GAAG,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAA;gBACrC,GAAG,CAAC,MAAM,CAAC,CAAC,GAAG,IAAI,GAAG,UAAU,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;oBACrD,IAAI,CAAC;wBACH,IAAI,IAAe,CAAC;wBACpB,IAAI,aAAa,EAAE,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;4BACpC,MAAM,OAAO,GAAG,IAAA,2BAA4B,GAAE,CAAC;4BAC/C,MAAM,EAAE,IAAI,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC;4BAC7B,MAAM,YAAY,GAA6C,MAAM,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;4BAEnG,IAAI,YAAY,CAAC,OAAO,EAAE,CAAC;gCACzB,MAAM,KAAK,GAAG,IAAI,oBAAS,CAAC;oCAC1B,OAAO,EAAE,yDAAyD;oCAClE,IAAI,EAAE,YAAY,CAAC,KAAK;oCACxB,UAAU,EAAE,GAAG;iCAChB,CAAC,CAAC;gCACH,OAAO,MAAM,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;4BACtD,CAAC;4BAED,IAAI,GAAG,YAAY,CAAC,OAAO,CAAC;wBAC9B,CAAC;wBAED,MAAM,GAAG,GAAG,MAAO,UAA+C,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,IAAK,CAAC,CAAC;wBAC5F,OAAO,GAAG,CAAC;oBACb,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACX,MAAM,KAAK,GAAG,IAAI,oBAAS,CAAC;4BAC1B,OAAO,EAAG,CAAS,CAAC,OAAO;4BAC3B,IAAI,EAAE,CAAC;yBACR,CAAC,CAAC;wBAEH,MAAM,MAAM,GAAG,IAAA,wBAAmB,GAAE,CAAC;wBACrC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;wBACnC,MAAM,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBAC/C,CAAC;gBACH,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAED,WAAW,CAAC,oBAAU,EAAE,KAAK,CAAC,CAAC;IAC/B,WAAW,CAAC,qBAAW,EAAE,MAAM,CAAC,CAAC;IACjC,WAAW,CAAC,sBAAY,EAAE,OAAO,CAAC,CAAC;IACnC,WAAW,CAAC,oBAAU,EAAE,KAAK,CAAC,CAAC;IAC/B,WAAW,CAAC,uBAAa,EAAE,QAAQ,CAAC,CAAC;AACvC,CAAC;AA/DD,qCA+DC","debug_id":"1e900a44-cb28-5704-9fa6-88607bb4eebe"}