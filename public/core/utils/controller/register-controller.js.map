{"version":3,"file":"register-controller.js","sources":["core/utils/controller/register-controller.ts"],"sourceRoot":"/","sourcesContent":["import { FastifyInstance } from 'fastify';\nimport UserSchema from '../../features/user/schemas/user-schema';\nimport { IDecodeUserTokenUsecase, decodeUserTokenErrors } from '../../features/user/usecases/decode-user-token/types';\nimport HttpError from '../errors/http-error';\nimport createLoggerService from '../services/logger-service';\nimport { Either } from '../types';\nimport { SYMBOL_DELETE, SYMBOL_GET, SYMBOL_PATCH, SYMBOL_POST, SYMBOL_PRIVATE, SYMBOL_PUT } from '../decorators/controller/symbols';\nimport { controllerAction, IControllerActionMeta } from '../decorators/controller/types';\nimport createContainer from '../decorators/container';\n\nexport default function registerController(\n  path: string,\n  controller: object,\n  app: FastifyInstance\n) {\n  function processMeta(\n    symbol: symbol,\n    method: 'get' | 'post' | 'patch' | 'put' | 'delete'\n  ) {\n    if (Reflect.hasMetadata(symbol, controller.constructor)) {\n      const actions = Reflect.getMetadata(\n        symbol,\n        controller.constructor\n      ) as IControllerActionMeta[];\n      const privateRoutes = Reflect.getMetadata(\n        SYMBOL_PRIVATE,\n        controller.constructor\n      ) as string[];\n\n      actions.forEach(({ path: p, action }) => {\n        const actionPath = p === '/' ? '' : p\n        app[method](`${path}${actionPath}`, async (req, rep) => {\n          try {\n            let user: UserSchema;\n            if (privateRoutes?.includes(action)) {\n              const decoder = createContainer().get<IDecodeUserTokenUsecase>('IDecodeUserTokenUsecase');\n              const { auth } = req.headers;\n              const decodeResult: Either<decodeUserTokenErrors, UserSchema> = await decoder.execute(String(auth));\n\n              if (decodeResult.isError) {\n                const error = new HttpError({\n                  message: 'Desculpe, vocÃª precisa estar autenticado para acessar esse recurso.',\n                  meta: decodeResult.error,\n                  statusCode: 403\n                });\n                return await rep.code(error.statusCode).send(error);\n              }\n\n              user = decodeResult.success;\n            }\n\n            const res = await (controller as Record<string, controllerAction>)[action](req, rep, user!);\n            return res;\n          } catch (e) {\n            const error = new HttpError({\n              message: (e as any).message,\n              meta: e\n            });\n\n            const logger = createLoggerService();\n            logger.error(error.message, error);\n            await rep.code(error.statusCode).send(error);\n          }\n        });\n      });\n    }\n  }\n\n  processMeta(SYMBOL_GET, 'get');\n  processMeta(SYMBOL_POST, 'post');\n  processMeta(SYMBOL_PATCH, 'patch');\n  processMeta(SYMBOL_PUT, 'put');\n  processMeta(SYMBOL_DELETE, 'delete');\n}\n"],"names":[],"mappings":";;;;;;;AAGA,sEAA6C;AAC7C,gFAA6D;AAE7D,8DAAoI;AAEpI,wEAAsD;AAEtD,SAAwB,kBAAkB,CACxC,IAAY,EACZ,UAAkB,EAClB,GAAoB;IAEpB,SAAS,WAAW,CAClB,MAAc,EACd,MAAmD;QAEnD,IAAI,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,UAAU,CAAC,WAAW,CAAC,EAAE,CAAC;YACxD,MAAM,OAAO,GAAG,OAAO,CAAC,WAAW,CACjC,MAAM,EACN,UAAU,CAAC,WAAW,CACI,CAAC;YAC7B,MAAM,aAAa,GAAG,OAAO,CAAC,WAAW,CACvC,wBAAc,EACd,UAAU,CAAC,WAAW,CACX,CAAC;YAEd,OAAO,CAAC,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE;gBACtC,MAAM,UAAU,GAAG,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAA;gBACrC,GAAG,CAAC,MAAM,CAAC,CAAC,GAAG,IAAI,GAAG,UAAU,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;oBACrD,IAAI,CAAC;wBACH,IAAI,IAAgB,CAAC;wBACrB,IAAI,aAAa,EAAE,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;4BACpC,MAAM,OAAO,GAAG,IAAA,mBAAe,GAAE,CAAC,GAAG,CAA0B,yBAAyB,CAAC,CAAC;4BAC1F,MAAM,EAAE,IAAI,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC;4BAC7B,MAAM,YAAY,GAA8C,MAAM,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;4BAEpG,IAAI,YAAY,CAAC,OAAO,EAAE,CAAC;gCACzB,MAAM,KAAK,GAAG,IAAI,oBAAS,CAAC;oCAC1B,OAAO,EAAE,qEAAqE;oCAC9E,IAAI,EAAE,YAAY,CAAC,KAAK;oCACxB,UAAU,EAAE,GAAG;iCAChB,CAAC,CAAC;gCACH,OAAO,MAAM,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;4BACtD,CAAC;4BAED,IAAI,GAAG,YAAY,CAAC,OAAO,CAAC;wBAC9B,CAAC;wBAED,MAAM,GAAG,GAAG,MAAO,UAA+C,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,IAAK,CAAC,CAAC;wBAC5F,OAAO,GAAG,CAAC;oBACb,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACX,MAAM,KAAK,GAAG,IAAI,oBAAS,CAAC;4BAC1B,OAAO,EAAG,CAAS,CAAC,OAAO;4BAC3B,IAAI,EAAE,CAAC;yBACR,CAAC,CAAC;wBAEH,MAAM,MAAM,GAAG,IAAA,wBAAmB,GAAE,CAAC;wBACrC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;wBACnC,MAAM,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBAC/C,CAAC;gBACH,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAED,WAAW,CAAC,oBAAU,EAAE,KAAK,CAAC,CAAC;IAC/B,WAAW,CAAC,qBAAW,EAAE,MAAM,CAAC,CAAC;IACjC,WAAW,CAAC,sBAAY,EAAE,OAAO,CAAC,CAAC;IACnC,WAAW,CAAC,oBAAU,EAAE,KAAK,CAAC,CAAC;IAC/B,WAAW,CAAC,uBAAa,EAAE,QAAQ,CAAC,CAAC;AACvC,CAAC;AA/DD,qCA+DC","debug_id":"d336fa8b-dd86-5170-8c1d-b95ebf8202ca"}