{"version":3,"file":"controller.js","sources":["core/features/user/controller/controller.ts"],"sourceRoot":"/","sourcesContent":["import { FastifyReply, FastifyRequest } from 'fastify';\nimport Controller from '../../../utils/decorators/controller/controller';\nimport HttpError from '../../../utils/errors/http-error';\nimport UserModel, { UserProps } from '../models/user-model';\nimport { IAuthenticateUserUsecase, LoginPayload } from '../usecases/authenticate-user/types';\nimport { IDecodeUserTokenUsecase } from '../usecases/decode-user-token/types';\nimport { IInsertUserUsecase } from '../usecases/insert-user/types';\nimport { ISignUserTokenUsecase } from '../usecases/sign-user-token/types';\nimport { IValidateUserUsecase } from '../usecases/validate-user/types';\nimport privateRoute from '../../../utils/decorators/controller/private-route';\nimport { ChangePasswordBody, IChangePasswordUsecase } from '../usecases/change-password/types';\nimport { IUpdateUserUsecase, updateUserProps } from '../usecases/update-user/types';\nimport Post from '../../../utils/decorators/controller/post';\nimport Get from '../../../utils/decorators/controller/get';\nimport Patch from '../../../utils/decorators/controller/patch';\nimport Put from '../../../utils/decorators/controller/put';\nimport { inject } from 'inversify';\n\n@Controller('/user')\nexport default class UserController {\n  constructor(\n    @inject('IValidateUserUsecase')\n    private readonly validateUser: IValidateUserUsecase,\n    @inject('IInsertUserUsecase')\n    private readonly insertUser: IInsertUserUsecase,\n    @inject('ISignUserTokenUsecase')\n    private readonly signUserToken: ISignUserTokenUsecase,\n    @inject('IAuthenticateUserUsecase')\n    private readonly authenticateUser: IAuthenticateUserUsecase,\n    @inject('IDecodeUserTokenUsecase')\n    private readonly decodeUserToken: IDecodeUserTokenUsecase,\n    @inject('IChangePasswordUsecase')\n    private readonly changePassword: IChangePasswordUsecase,\n    @inject('IUpdateUserUsecase')\n    private readonly updateUser: IUpdateUserUsecase\n  ) { }\n\n  @Post('/new')\n  async new(req: FastifyRequest, reply: FastifyReply) {\n    const payload = req.body as Omit<UserProps, 'id'>;\n    const validate = this.validateUser.execute(payload);\n    if (validate.isError) {\n      const error = new HttpError({\n        ...validate.error,\n        statusCode: 400\n      });\n      return await reply.code(error.statusCode).send(error);\n    }\n\n    const insertResult = await this.insertUser.execute(payload);\n    if (insertResult.isError) {\n      const error = new HttpError(insertResult.error);\n      if (insertResult.error.type === 'insert-user-already-exist') error.statusCode = 409;\n      return await reply.code(error.statusCode).send(error);\n    }\n\n    const { success: user } = insertResult;\n    const auth = this.signUserToken.execute(user);\n    return await reply.send({ auth, user });\n  }\n\n  @Post('/authenticate')\n  async authenticate(req: FastifyRequest, reply: FastifyReply) {\n    const payload = req.body as LoginPayload;\n    const authResult = await this.authenticateUser.execute(payload);\n    if (authResult.isError) {\n      const error = new HttpError({\n        ...authResult.error,\n        statusCode: {\n          'authenticate-user-not-found': 404,\n          'authenticate-user-wrong-password': 403,\n          'authenticate-invalid': 400\n        }[String(authResult.error.type)] ?? 500\n      });\n      return await reply.code(error.statusCode).send(error);\n    }\n\n    const { success: user } = authResult;\n    const auth = this.signUserToken.execute(user);\n    return await reply.send({ user, auth });\n  }\n\n  @Get('/decode')\n  async decode(req: FastifyRequest, reply: FastifyReply) {\n    const { auth } = req.headers;\n    const result = await this.decodeUserToken.execute(String(auth));\n    if (!result.isError) return await reply.send(result.success.getProps());\n\n    const error = new HttpError({\n      ...result.error,\n      statusCode: {\n        'decode-user-invalid-token': 400,\n        'decode-user-not-found': 404\n      }[String(result.error.type)] ?? 500\n    });\n    return await reply.code(error.statusCode).send(error);\n  }\n\n  @Patch('/change-password')\n  @privateRoute()\n  async changeUserPassword(req: FastifyRequest, reply: FastifyReply, user: UserModel) {\n    const { body } = req as { body: ChangePasswordBody };\n    const result = await this.changePassword.execute({\n      ...body,\n      userId: user.id!\n    });\n    if (!result.isError) return await reply.send({ message: result.success });\n\n    const error = new HttpError(result.error)\n    if (result.error.type === 'change-password-invalid-pass') {\n      error.statusCode = 400;\n    }\n    return await reply.code(error.statusCode).send(error);\n  }\n\n  @Put('/update-user')\n  @privateRoute()\n  async update(req: FastifyRequest, reply: FastifyReply, user: UserModel) {\n    const { body } = req as { body: updateUserProps };\n    const result = await this.updateUser.execute(user, body);\n    if (!result.isError) return await reply.send();\n\n    const error = new HttpError(result.error);\n    if (result.error.type === 'update-user-invalid-pass') error.statusCode = 403;\n    return await reply.code(error.statusCode).send(error);\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"e94875d5-930c-5c78-a10b-f035c91a02e9"}