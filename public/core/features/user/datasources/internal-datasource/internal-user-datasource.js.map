{"version":3,"file":"internal-user-datasource.js","sources":["core/features/user/datasources/internal-datasource/internal-user-datasource.ts"],"sourceRoot":"/","sourcesContent":["import { ILoggerService } from '../../../../utils/services/logger-service/types';\nimport { Either, Left, Right } from '../../../../utils/types';\nimport { DataSource, Repository } from 'typeorm';\nimport UserSchema from '../../schemas/user-schema';\nimport { IInternalUserDatasource, InternalUserDatasourceError } from './types';\nimport Injectable from '../../../../utils/decorators/injectable';\nimport { inject } from 'inversify';\nimport { ObjectId } from 'mongodb';\nimport User from '../../entities/user';\n\n@Injectable('IInternalUserDatasource')\nexport default class InternalUserDatasource implements IInternalUserDatasource {\n  constructor(\n    @inject('Repository<UserSchema>')\n    private readonly userRepository: Repository<UserSchema>,\n\n    @inject('ILoggerService')\n    private readonly logger: ILoggerService,\n\n    @inject('DataSource')\n    private readonly dataSource: DataSource\n  ) { }\n\n  async findManyByIds(userIds: string[]) {\n    try {\n      const users: UserSchema[] = await this.dataSource\n        .getMongoRepository(UserSchema)\n        .find({\n          where: {\n            _id: { $in: userIds.map((userId) => new ObjectId(userId)) }\n          }\n        });\n\n      return new Right(users.map((user) => new User(user.getProps())));\n    } catch (e: any) {\n      console.log(e);\n\n      const error = new InternalUserDatasourceError(\n        e.message || `Oops, desculpe, tivemos um problema buscando por (${userIds.join(', ')})`,\n        { ...e, userIds }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n\n  async findByEmail(email: string) {\n    try {\n      const user = await this.userRepository.findOneBy({ email });\n      return new Right(user ? new User(user?.getProps()) : null);\n    } catch (e) {\n      const error = new InternalUserDatasourceError(\n        (e as any).message || `Oops, desculpe, tivemos um problema buscando por ${email}`,\n        { ...(e as any), email }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n\n  async findById(userId: string) {\n    try {\n      const user = await this.userRepository.findOneBy({\n        _id: new ObjectId(userId)\n      } as any);\n      return new Right(user ? new User(user.getProps()) : null);\n    } catch (e) {\n      const error = new InternalUserDatasourceError(\n        (e as any).message || `Opa, foi mal tivemos um problema buscando pelo usuário ${userId}`,\n        { ...(e as any), userId }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n\n  async save(user: User): Promise<Either<InternalUserDatasourceError, User>> {\n    try {\n      const result = await this.userRepository.save(new UserSchema({\n        ...user,\n        id: undefined\n      }));\n      result.password = undefined;\n      return new Right(new User({\n        ...result,\n        id: result.id?.toString()\n      }));\n    } catch (e) {\n      const error = new InternalUserDatasourceError(\n        (e as any).message || `Opa, foi mal tivemos um problema ao salvar o usuário ${user.name}`,\n        { ...(e as any), user }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n\n  async update(user: User) {\n    try {\n      await this.userRepository.update(user.id!, user);\n      return new Right(null);\n    } catch (e) {\n      const error = new InternalUserDatasourceError(\n        (e as any).message || `Opa, foi mal tivemos um problema para atualizar o usuário ${user.name}`,\n        { ...(e as any), user }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n\n  async remove(userId: string) {\n    try {\n      const user = await this.userRepository.findOneBy({ _id: new ObjectId(userId) } as any);\n      if (!user) throw new Error(`Oops, usuário ${userId.toString()} não encontrado, pode já ter sido deletado`);\n\n      const result = await this.userRepository.remove(user);\n      return new Right(new User({\n        ...result,\n        id: result.id?.toString()\n      }));\n    } catch (e) {\n      const error = new InternalUserDatasourceError(\n        (e as any).message || `Opa, foi mal tivemos um problema ao salvar o usuário ${userId}`,\n        { ...(e as any), userId }\n      );\n      this.logger.error(error.message, error);\n      return new Left(error);\n    }\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"4889e263-047a-5dc4-bf8b-6ae765beda39"}