{"version":3,"file":"internal-user-datasource.js","sources":["core/features/user/datasources/internal-datasource/internal-user-datasource.ts"],"sourceRoot":"/","sourcesContent":["import { ILoggerService } from '../../../../utils/services/logger-service/types';\r\nimport { Left, Right } from '../../../../utils/types';\r\nimport { Repository, ObjectId } from 'typeorm';\r\nimport UserModel from '../../models/user-model';\r\nimport { IInternalUserDatasource, InternalUserDatasourceError } from './types';\r\nimport Injectable from '../../../../utils/decorators/injectable';\r\nimport { inject } from 'inversify';\r\n\r\n@Injectable('IInternalUserDatasource')\r\nexport default class InternalUserDatasource implements IInternalUserDatasource {\r\n  constructor(\r\n    @inject('Repository<UserModel>') private readonly userRepository: Repository<UserModel>,\r\n    @inject('ILoggerService') private readonly logger: ILoggerService\r\n  ) { }\r\n\r\n  async findByEmail(email: string) {\r\n    try {\r\n      const user = await this.userRepository.findOneBy({ email });\r\n      return new Right(user);\r\n    } catch (e) {\r\n      const error = new InternalUserDatasourceError(\r\n        (e as any).message || `Oops, sorry got an error searching for ${email}`,\r\n        { ...(e as any), email }\r\n      );\r\n      this.logger.error(error.message, error);\r\n      return new Left(error);\r\n    }\r\n  }\r\n\r\n  async findById(userId: string) {\r\n    try {\r\n      const user = await this.userRepository.findOneBy({ id: userId as unknown as ObjectId });\r\n      return new Right(user);\r\n    } catch (e) {\r\n      const error = new InternalUserDatasourceError(\r\n        (e as any).message || `Opa, foi mal tivemos um problema buscando pelo usuário ${userId}`,\r\n        { ...(e as any), userId }\r\n      );\r\n      this.logger.error(error.message, error);\r\n      return new Left(error);\r\n    }\r\n  }\r\n\r\n  async save(user: UserModel) {\r\n    try {\r\n      const result = await this.userRepository.save(user);\r\n      result.password = undefined;\r\n      return new Right(result);\r\n    } catch (e) {\r\n      const error = new InternalUserDatasourceError(\r\n        (e as any).message || `Opa, foi mal tivemos um problema ao salvar o usuário ${user.name}`,\r\n        { ...(e as any), user }\r\n      );\r\n      this.logger.error(error.message, error);\r\n      return new Left(error);\r\n    }\r\n  }\r\n\r\n  async update(user: UserModel) {\r\n    try {\r\n      await this.userRepository.update(user.id!, user);\r\n      return new Right(null);\r\n    } catch (e) {\r\n      const error = new InternalUserDatasourceError(\r\n        (e as any).message || `Opa, foi mal tivemos um problema para atualizar o usuário ${user.name}`,\r\n        { ...(e as any), user }\r\n      );\r\n      this.logger.error(error.message, error);\r\n      return new Left(error);\r\n    }\r\n  }\r\n\r\n  async remove(userId: string) {\r\n    try {\r\n      const user = await this.userRepository.findOneBy({ id: userId as unknown as ObjectId });\r\n      if (!user) throw new Error(`Oops, usuário ${userId} não encontrado, pode já ter sido deletado`);\r\n\r\n      const result = await this.userRepository.remove(user);\r\n      return new Right(result);\r\n    } catch (e) {\r\n      const error = new InternalUserDatasourceError(\r\n        (e as any).message || `Opa, foi mal tivemos um problema ao salvar o usuário ${userId}`,\r\n        { ...(e as any), userId }\r\n      );\r\n      this.logger.error(error.message, error);\r\n      return new Left(error);\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debug_id":"b67b4a26-0c8c-5328-a5b3-aafeef29c740"}